name: Libraries CI/CD

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  NPM_VERSION: '11.6.1'
  JAVA_VERSION: '21'
  MAVEN_VERSION: '3.9.9'

concurrency:
  group: libs-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------- ANGULAR: build & test ----------
  ng_build_test:
    name: Angular ng-sse-client • build & test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: github-workflows/.github/actions/node-setup@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}
          registry-url: 'https://registry.npmjs.org'
      - name: Install dependencies
        uses: github-workflows/.github/actions/npm-install@main
        with:
          working-directory: '.'
          ci: true
      - name: Build
        uses: github-workflows/.github/actions/node-build@main
        with:
          working-directory: '.'
          script: 'build'
      - name: Test
        uses: github-workflows/.github/actions/node-test@main
        with:
          working-directory: '.'
          script: 'test'
          args: ''

  # ---------- MAVEN: build & test ----------
  maven_build_test:
    name: Java sse-server • build & test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: github-workflows/.github/actions/java-setup@main
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      - name: Maven Setup
        uses: github-workflows/.github/actions/maven-setup@main
        with:
          settings-file: .mvn/settings.xml
          working-directory: '.'
      - name: Build & test sse-server
        uses: github-workflows/.github/actions/maven-build@main
        with:
          goals: '-B -U -pl libs/sse-server verify'
          working-directory: '.'

  # ---------- Publish to npm (tags only) ----------
  publish_npm:
    name: Publish ng-sse-client to npm
    needs: [ng_build_test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      id-token: write # for npm provenance (optional)
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: github-workflows/.github/actions/node-setup@main
        with:
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}
          registry-url: 'https://registry.npmjs.org'
      - name: Install dependencies
        uses: github-workflows/.github/actions/npm-install@main
        with:
          working-directory: '.'
          ci: true
      - name: Build and Publish (npm run publish)
        uses: github-workflows/.github/actions/node-build@main
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        with:
          working-directory: '.'
          script: 'publish'

  # ---------- Publish to Maven Central (tags only) ----------
  publish_maven:
    name: Publish sse-server to Maven Central (OSSRH)
    needs: [maven_build_test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: github-workflows/.github/actions/java-setup@main
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      - name: Maven Setup
        uses: github-workflows/.github/actions/maven-setup@main
        with:
          settings-file: .mvn/settings.xml
          working-directory: '.'
      - name: Deploy (release profile)
        uses: github-workflows/.github/actions/maven-build@main
        with:
          goals: '-B -pl libs/sse-server -P release deploy'
          working-directory: '.'
